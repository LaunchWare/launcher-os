#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LAUNCHER_OS_DIR="$(dirname "$SCRIPT_DIR")"

show_help() {
  cat << EOF
Usage: launcher-os-install-webapp [OPTIONS] [NAME] [URL] [ICON_URL] [MIME_TYPES]

Install a site-specific browser application.

ARGUMENTS:
  NAME       Application name (e.g., "Gmail")
  URL        Web application URL (e.g., "https://mail.google.com")
  ICON_URL   Icon URL or local path (optional)
  MIME_TYPES Semicolon-separated MIME types to handle (optional)

OPTIONS:
  -h, --help    Show this help message
  -i, --interactive  Run in interactive mode

EXAMPLES:
  launcher-os-install-webapp Gmail https://mail.google.com
  launcher-os-install-webapp --interactive
  launcher-os-install-webapp Slack https://app.slack.com/client https://icon.png
  launcher-os-install-webapp Zoom https://zoom.us/wc https://zoom.ico "x-scheme-handler/zoom;x-scheme-handler/zoommtg"

If no arguments are provided, interactive mode is automatically enabled.
EOF
}

interactive_mode() {
  echo "=== launcher-os Site-Specific Browser Installation ==="
  echo

  read -p "Application name: " app_name
  read -p "Application URL: " app_url
  read -p "Icon URL (optional, press enter to skip): " icon_url
  read -p "MIME types (optional, e.g., x-scheme-handler/zoom): " mime_types

  if [[ -z "$app_name" || -z "$app_url" ]]; then
    echo "Error: Application name and URL are required"
    exit 1
  fi

  install_webapp "$app_name" "$app_url" "$icon_url" "$mime_types"
}

detect_ssb_browser() {
  local CHROMIUM_BROWSERS=("vivaldi" "vivaldi-stable" "chromium" "chromium-browser" "google-chrome" "google-chrome-stable" "brave-browser" "microsoft-edge" "opera")

  local default_desktop
  default_desktop=$(xdg-settings get default-web-browser 2>/dev/null)

  if [[ -n "$default_desktop" ]]; then
    local desktop_path
    for dir in "$HOME/.local/share/applications" /usr/share/applications /usr/local/share/applications; do
      if [[ -f "$dir/$default_desktop" ]]; then
        desktop_path="$dir/$default_desktop"
        break
      fi
    done

    if [[ -n "$desktop_path" ]]; then
      local binary
      binary=$(grep "^Exec=" "$desktop_path" | head -n1 | sed 's/^Exec=//' | awk '{print $1}' | xargs basename)
      for browser in "${CHROMIUM_BROWSERS[@]}"; do
        if [[ "$binary" == "$browser" ]]; then
          echo "$binary"
          return 0
        fi
      done
    fi
  fi

  for browser in "${CHROMIUM_BROWSERS[@]}"; do
    if command -v "$browser" &>/dev/null; then
      echo "$browser"
      return 0
    fi
  done

  echo "chromium"
}

install_webapp() {
  local name="$1"
  local url="$2"
  local icon_url="$3"
  local mime_types="$4"

  local ssb_browser
  ssb_browser=$(detect_ssb_browser)

  local safe_name=$(echo "$name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')
  local desktop_file="$HOME/.local/share/applications/${safe_name}-ssb.desktop"
  local icon_path="web-browser"
  local icon_dir="$HOME/.local/share/icons/hicolor/256x256/apps"

  # Create applications directory if it doesn't exist
  mkdir -p "$HOME/.local/share/applications"

  to_png_256() {
    local src="$1" dst="$2"
    if command -v magick &>/dev/null; then
      magick "${src}[0]" -resize 256x256 -background none -gravity center -extent 256x256 "$dst" 2>/dev/null
    elif command -v convert &>/dev/null; then
      convert "${src}[0]" -resize 256x256 -background none -gravity center -extent 256x256 "$dst" 2>/dev/null
    else
      return 1
    fi
  }

  install_icon() {
    local src="$1"
    local dst="$icon_dir/${safe_name}.png"
    mkdir -p "$icon_dir"
    if to_png_256 "$src" "$dst"; then
      icon_path="$dst"
      echo "Icon installed to $dst"
    else
      echo "Failed to convert icon, using default"
    fi
  }

  # Handle icon if provided
  if [[ -n "$icon_url" ]]; then
    if [[ "$icon_url" =~ ^https?:// ]]; then
      local icon_ext="${icon_url##*.}"
      [[ "$icon_ext" != "png" && "$icon_ext" != "jpg" && "$icon_ext" != "jpeg" && "$icon_ext" != "ico" ]] && icon_ext="png"
      local tmp_icon
      tmp_icon=$(mktemp --suffix=".${icon_ext}")
      echo "Downloading icon..."
      if curl -s -L -o "$tmp_icon" "$icon_url"; then
        install_icon "$tmp_icon"
      else
        echo "Failed to download icon, using default"
      fi
      rm -f "$tmp_icon"
    else
      if [[ -f "$icon_url" ]]; then
        install_icon "$icon_url"
      else
        echo "Icon file not found, using default"
      fi
    fi
  fi

  # Extract domain for pattern matching and class computation
  local domain=$(echo "$url" | sed -E 's|^https?://([^/]+).*|\1|')

  # Chromium-based browsers generate a Wayland app_id in --app mode of the form:
  #   <browser_basename>-<domain>__-Default
  # The --class flag is ignored for the Wayland app_id in --app mode.
  local browser_base
  browser_base=$(basename "$ssb_browser" | sed -E 's/-(stable|browser|bin)$//')
  local wayland_class="${browser_base}-${domain}__-Default"

  # Build MIME types
  local full_mime_types="text/html;text/xml;application/xhtml+xml;"
  if [[ -n "$mime_types" ]]; then
    # Add custom MIME types, ensuring they end with semicolon
    full_mime_types="${full_mime_types}${mime_types%;};"
  fi

  # Create desktop entry
  cat > "$desktop_file" << EOF
[Desktop Entry]
Name=$name
Exec=$ssb_browser --app="$url" %u
Icon=$icon_path
Type=Application
Categories=Network;
StartupWMClass=$wayland_class
MimeType=$full_mime_types
EOF

  echo "✓ Desktop entry created: $desktop_file"

  # Register MIME types if specified
  if [[ -n "$mime_types" ]]; then
    echo "Registering MIME type handlers..."
    local desktop_filename="${safe_name}-ssb.desktop"

    # Split mime_types by semicolon and register each one
    IFS=';' read -ra MIME_ARRAY <<< "$mime_types"
    for mime_type in "${MIME_ARRAY[@]}"; do
      if [[ -n "$mime_type" ]]; then
        xdg-mime default "$desktop_filename" "$mime_type" 2>/dev/null || true
        echo "  ✓ Registered handler for $mime_type"
      fi
    done
  fi

  echo "✓ $name will appear in your application launcher"
  echo
  echo "To add a keybind, add this to your Hyprland config:"
  echo "bind = SUPER, [KEY], exec, launch-os-launch-or-focus.sh \"$domain\" \"$ssb_browser --app=$url\""
}

# Parse arguments
case "${1:-}" in
  -h|--help)
    show_help
    exit 0
    ;;
  -i|--interactive)
    interactive_mode
    exit 0
    ;;
  "")
    interactive_mode
    exit 0
    ;;
  *)
    if [[ $# -lt 2 ]]; then
      echo "Error: NAME and URL are required"
      echo "Use --help for usage information"
      exit 1
    fi
    install_webapp "$1" "$2" "${3:-}" "${4:-}"
    ;;
esac